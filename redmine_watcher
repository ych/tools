#!/usr/bin/env ruby

require 'net/http'
require 'net/smtp'
require 'rexml/document'
require 'rubygems'
require 'docopt'
require 'inifile'

doc = <<DOCOPT

Usage:
  #{__FILE__} site <site_url> [--config=<file>]
  #{__FILE__} key <atom_key_token> [--config=<file>]
  #{__FILE__} email <email_address> [--config=<file>]
  #{__FILE__} watch <issue_number> [--config=<file>]
  #{__FILE__} unwatch <issue_number> [--config=<file>]
  #{__FILE__} list [--config=<file>]
  #{__FILE__} fetch [--config=<file>]
  #{__FILE__} -h | --help
  #{__FILE__} --version

Options:
  -h --help        Show this screen.
  --version        Show version.
  --config=<file>  Assign path of the configure file.

DOCOPT

begin
  opt = Docopt::docopt(doc, version: '0.0.2')
rescue Docopt::Exit => e
  puts e.message
end


if opt != nil
  if opt["--config"] == nil
    file = "config.ini"
  else
    file = opt["--config"]
  end

  ini = IniFile.new(:filename => file)

  if opt["site"] == true
    ini["user"]["site"] = opt["<site_url>"]
  elsif opt["key"] == true
    ini["user"]["key"] = opt["<atom_key_token>"]
  elsif opt["email"] == true
    ini["user"]["email"] = opt["<email_address>"]
  elsif opt["watch"] == true
    ini["issues"][opt["<issue_number>"]] = ""
  elsif opt["unwatch"] == true
    ini["issues"].delete(opt["<issue_number>"])
  elsif opt["list"] == true
    print "The following issues are watched: #{ini["issues"].keys}\n"
  elsif opt["fetch"] == true
    if ini["user"]["site"] == nil || ini["user"]["key"] == nil || ini["user"]["email"] == nil
      print "You should set up redmine site, key and your email!\n"
      exit
    end
    ini["issues"].keys.each do |issue|
      uri = URI(sprintf("%s/issues/%s.atom", ini["user"]["site"], issue))
      params = {:key => ini["user"]["key"]}
      uri.query = URI.encode_www_form(params)
      res = Net::HTTP.get_response(uri)
      if res.is_a?(Net::HTTPSuccess)
	xmldoc = REXML::Document.new(res.body)
  	lastupdated = ""
	# Save last "updated" record.
	xmldoc.root.elements.each("entry/updated") { |element| lastupdated = element.to_s }
	# If no entry, updated will be changed all the time.
	if xmldoc.root.elements['entry'] != nil && lastupdated != ini["issues"][issue]
	  message = sprintf("From: Redmine Watcher <no-reply@exmaple.com>\nTo: User<%s>\nSubject: Issue %s has new response!\n\nPlease connect %s/issues/%s to read new response!", ini["user"]["email"], issue, ini["user"]["site"], issue)
	  Net::SMTP.start('localhost') do |smtp|
	    smtp.send_message message, "no-reply@example.com", ini["user"]["email"]
	  end
	  ini["issues"][issue] = lastupdated
        end
      end
    end
  end
  ini.write
end
